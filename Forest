# Libraries ----

library(sf)
library(raster)
library(terra)
library(purrr)
library(furrr)
library(ggridges)
library(tidyverse)

# Import data----

montesole <- stack("/home/alessio/Tirocinio/Foresta/montesole.tif") # stack o brick per importare piÃ¹ immagini o una sola immagine con diverse bande

buffer <- st_read("/home/alessio/Tirocinio/Foresta/Study_area.gpkg")

foreste <- st_read("/home/alessio/Tirocinio/Foresta/AreeForestali2014BO.shp")


# Pre-processing ----

# Print the CRS of 'foreste' and 'buffer'
print(st_crs(foreste))
print(st_crs(buffer))

# If the CRS is not the same, you need to reproject one of them to match the other
# For example, if 'buffer' has a different CRS than 'foreste', you can reproject 'buffer' to the CRS of 'foreste'
foreste <- st_transform(foreste, crs = st_crs(buffer))

# Now, the CRS should be the same
print(st_crs(foreste))
print(st_crs(buffer))

# Check validity of geometries
print(st_is_valid(foreste))
print(st_is_valid(buffer))

# Fix invalid geometries
foreste <- st_make_valid(foreste)

# Crop foreste according to Monte Sole buffer
foreste <- st_intersection(foreste, buffer)

# Crop montesole tif according to Monte Sole buffer

montesole <- projectRaster(montesole, crs = crs(buffer)) # here we change the montesole crs to match with buffer crs

montesole <- crop(montesole, buffer)

montesole <- mask(montesole, buffer)

# Extract Values ----

df_montesole <- terra::extract(montesole, foreste, df = TRUE)

df_montesole$montesole_4 <- NULL  # remove useless column

# modify column names

# df_montesole <- map(df_montesole, ~{
#   colnames(.) <- c("ID_poly", paste0("banda_", 1:(ncol(.)-1)))
#   .
# })


# add columns with information from original forest chart polygons

unique(df_montesole$ID)     # check variable levels
unique(foreste$TIPO_CARTA)
unique(foreste$PRIMA_SP)

foreste$TIPO_CARTA <- as.factor(foreste$TIPO_CARTA) # transform variables into factors (not sure it is necessary)
foreste$PRIMA_SP <- as.factor(foreste$PRIMA_SP)
df_montesole$ID <- as.factor(df_montesole$ID)

df_montesole$specie <- foreste$PRIMA_SP[df_montesole$ID]  # add the new species column
df_montesole$management <- foreste$TIPO_CARTA[df_montesole$ID]  # add the management column

unique(df_montesole$specie) # check results
unique(df_montesole$management)

# Ridgeplots ----

# Ridgeplot on single spectral band

df_montesole %>%
  ggplot(aes(y = specie)) +
  geom_density_ridges(aes(x = montesole_1, fill = governo),
                      alpha = 0.8, color = "white") +
  labs(x = "band_1",
       y = "governo",
       title = "difference in band_3 depending on governo") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.25))) +
  scale_fill_viridis_c(name = "NDVI", option = "C") +
  coord_cartesian(clip = "off") +
  theme_ridges(grid = T)


# Ridgeplot on multiple spectral bands

# Stack columns bands into a single column: transform the dataframe from wide to long format

df_montesole_stacked <- df_montesole %>%
  pivot_longer(cols = c(montesole_1, montesole_2, montesole_3), names_to = "Band", values_to = "Value") %>%
  arrange(ID) %>%
  as.factor(df_montesole_stacked$Band)

# free some memory if necessary

rm(df_montesole)

# here the multi-band Ridgeplot

# according to management

df_montesole_stacked %>%
  ggplot(aes(y = governo)) +
  geom_density_ridges(aes(x = Value, fill = Band),
                      alpha = 0.8, color = "white") +
  labs(x = "Reflectance",
       y = "Forest management",
       title = "Difference in spectral bands depending on forest management") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.25))) +
  coord_cartesian(clip = "off") +
  theme_ridges(grid = T)

# according to species

df_montesole_stacked %>%
  ggplot(aes(y = specie)) +
  geom_density_ridges(aes(x = Value, fill = Band),
                      alpha = 0.8, color = "white") +
  labs(x = "Reflectance",
       y = "First species",
       title = "Difference in spectral bands depending on forest main species") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.25))) +
  coord_cartesian(clip = "off") +
  theme_ridges(grid = T)
